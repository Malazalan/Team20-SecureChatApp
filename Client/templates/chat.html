<!DOCTYPE html>
<html>
<head>
<title>Home</title>
</head>
<body>
    
    <h1>Logged in user:{{ current_user.username }}</h1>
    
    <h2>Chatting with {{target_user_id}}</h2>
    
    <div id="messages">
    <b>Contents of chat:</b>
    <br>
    <b>----------------------------------------------</b>
    </div>

    <b>----------------------------------------------</b>
    
    <br> 

    <form id="send_message_form">
        <input type = "text" id = "message_input" placeholder="Message:">
        <button type="submit">Send</button>
    </form>
    
    <br>

    <form action="/home">
        <button type="submit">Home</button>
    </form>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
<script>
// TODO: Add something to show if a user is online
// TODO: make an option on homepage to clear (overwrite with 0's first) the local storage
// TODO: add an option to clear the history for a certain chat

// TODO: add a checkbox for if messages should be saved to local storage

window.onload = function() {  
    const savedMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
    savedMessages.forEach(message => {
        if (message.target === "{{target_user_id}}" && message.username === "{{current_user.username}}") {
            console.log(message); 
            appendMessage(message);
        }
    });
};

    const socket = io.connect("http://127.0.0.1:5000");
    socket.on('connect', function(){
        socket.emit('user_connect',{
            username: "{{current_user.username}}",
            target: "{{target_user_id}}"
        })
    })

    let message_input = document.getElementById('message_input');

    document.getElementById('send_message_form').onsubmit = function (e) {
        e.preventDefault();
        let message = message_input.value;//.trim();
        if (message.length){
            // TODO: message should be encrypted
            // TODO: message needs data cleaning done to it here
            //       I assume
            socket.emit('message_sent',{
                username: "{{current_user.username}}",
                target: "{{target_user_id}}",
                message: message
            })

        message_input.value = '';
        }
    }

    socket.on('recieve_message', function (data) {
        console.log(data);
        const newNode = document.createElement('div');
        newNode.innerHTML = `<b>${data.username}:&nbsp;</b> ${data.message}`;
        document.getElementById('messages').appendChild(newNode);
    
        saveMessageToLocalStorage(data);
    });

    function appendMessage(data) {
        const newNode = document.createElement('div');
        newNode.innerHTML = `<b>${data.username}:&nbsp;</b> ${data.message}`;
        document.getElementById('messages').appendChild(newNode);
    }

    function saveMessageToLocalStorage(message) {
        let savedMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
        savedMessages.push(message);
        localStorage.setItem('chatMessages', JSON.stringify(savedMessages));
    }

</script>





</html>