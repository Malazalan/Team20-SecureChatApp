<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #788eef, #9464c4);
            color: #9a9191;
            text-align: center;
            padding: 50px 0; /* Add padding to the top and bottom of the page */
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 40px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }



        h1, h2 {
            margin-bottom: 20px; /* Add margin to headings */
        }


        #messages {
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        form#send_message_form {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; /* Adjust spacing between form elements */
            width: 100%;
        }

        input[type="text"],
        input[type="checkbox"] {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        input[type="checkbox"] {
            min-width: 120px;
            padding: 10px 20px;
        }

        .custom-file-input {
            position: relative;
            display: inline-block;
        }

        .custom-file-input::before {
            content: 'upload';
            display: block;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            background-color: #2d8cf3;
            color: #fff;
            text-align: center;
            transition: background-color 0.2s;
        }

        .custom-file-input:hover::before {
            background-color: #095ab0;
        }

        .custom-file-input input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            background-color: #298dfa;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled,
        button:disabled:hover {
            background-color: #cccccc;
            cursor: not-allowed;
        }


        .button-container {
            display: flex;
            justify-content: center;
            align-items: center; /* Align items vertically */
            flex-wrap: wrap; /* Allows buttons to wrap onto the next line if space is limited */
            gap: 10px; /* Adds a gap between the buttons */
            margin-top: 10px; /* Space above the button container */
        }


        #save_chat_checkbox {
            cursor: pointer;
            margin-right: -40px;

        }

        .save-chat-container label {
            cursor: pointer;
        }

        /* Ensure button and checkbox sizes are consistent */
        button, input[type="checkbox"] {
            min-width: 100px; /* Ensures a minimum width for buttons */
            padding: 10px 20px; /* Consistent padding for buttons */
        }
        #consentCheckbox {
            margin-right: -30px; /* 增加复选框和标签之间的间距 */
        }
        .consent-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            margin-left: 1px;
        }

        .consent-container label {
            margin-right: 1px;
        }
        .custom-file-input .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .custom-file-input:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

    </style>
</head>
<body>
<div class="container">
    <h1>Logged in user: {{ current_user.username }}</h1>
    <h2>Chatting with {{ target_user_id }}</h2>

    <div id="messages">
        <b>Contents of chat:</b>
        <br>
        <b>----------------------------------------------</b>
    </div>

    <!-- File upload form -->
    <form id="send_message_form">
        <input type="text" id="message_input" placeholder="Type your message here...">

        <div class="consent-container">
            <input type="checkbox" id="consentCheckbox">
            <label for="consentCheckbox">I have read and agree to the
                <a href="{{ url_for('terms') }}" target="_blank">Terms of Service</a> and
                <a href="{{ url_for('privacy') }}" target="_blank">Privacy Policy</a>.
            </label>
        </div>


        <div class="custom-file-input" id="fileInputLabel">
            <input type="file" id="file_input" style="display:block;">
            <span class="tooltip-text">Maximum allowed upload file size is 100MB</span>
        </div>

        <button type="submit" id="sendButton" disabled>Send</button>
    </form>
    <div class="button-container">
        <button id="clearChatHistoryButton" type="button" onclick="clearChatHistory()">Clear Chat History</button>
        <button id="homeButton" type="button" onclick="navigateHome()">Home</button>
        <div>

        <!-- Checkbox to enable/disable saving chat messages locally -->
        <input type="checkbox" id="save_chat_checkbox"checked>
        <label for="save_chat_checkbox">Save received messages locally</label>
    </div>
</div>
</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <script>
        window.onload = function() {
            const savedMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
            savedMessages.forEach(message => {
                appendMessage(message);
            });

            const consentCheckbox = document.getElementById('consentCheckbox');
            const sendButton = document.getElementById('sendButton');
            const fileInput = document.getElementById('file_input');
            const fileInputLabel = document.getElementById('fileInputLabel');

            const isConsented = localStorage.getItem('userConsented') === 'true';
            consentCheckbox.checked = isConsented;
            sendButton.disabled = !isConsented;
            fileInput.disabled = !isConsented;
            fileInputLabel.style.pointerEvents = isConsented ? 'auto' : 'none';
            fileInputLabel.style.opacity = isConsented ? '1' : '0.5';

            consentCheckbox.addEventListener('change', function() {
                sendButton.disabled = !this.checked;
                fileInput.disabled = !this.checked;
                fileInputLabel.style.pointerEvents = this.checked ? 'auto' : 'none';
                fileInputLabel.style.opacity = this.checked ? '1' : '0.5';
                localStorage.setItem('userConsented', this.checked);
            });
        };


        const socket = io.connect("http://127.0.0.1:5000");
        socket.on('connect', function(){
            socket.emit('user_connect',{
                username: "{{current_user.username}}",
                target: "{{target_user_id}}"
            });
        });

        let message_input = document.getElementById('message_input');
        let file_input = document.getElementById('file_input');
        let save_chat_checkbox = document.getElementById('save_chat_checkbox');

        document.getElementById('send_message_form').onsubmit = function(e) {
            e.preventDefault();

            const isConsented = localStorage.getItem('userConsented') === 'true';
            if (!isConsented) {
                alert('Please agree to the terms of service and privacy policy before sending messages.');
                return;
            }
            let message = message_input.value;
            let file = file_input.files[0]; // Get the selected file
            if (message.length || file) {
                socket.emit('message_sent', {
                    username: "{{current_user.username}}",
                    target: "{{target_user_id}}",
                    message: message,
                    file: file ? { // Send file along with the message
                        name: file.name,
                        url: URL.createObjectURL(file)
                    } : null,
                    saveLocally: save_chat_checkbox.checked // Include whether to save locally in the message
                });

                message_input.value = '';
                file_input.value = ''; // Reset file input
            }
        };

        document.getElementById('clearChatHistoryButton').onclick = function (e) {
            replaceCharacters();
            setTimeout(function() {
            clearChat();
            }, 3000); // 3000毫秒 = 3秒
        };

        socket.on('recieve_message', function (data) {
            appendMessage(data);
            if (save_chat_checkbox.checked) {
                saveMessageToLocalStorage(data);
            }
        });

        function appendMessage(data) {
            const newNode = document.createElement('div');
            if (data.file) {
                // If the message contains a file, create a node with a download link
                newNode.innerHTML = `<b>${data.username}:&nbsp;</b> File: <a href="${data.file.url}" download="${data.file.name}">${data.file.name}</a>`;
            } else {
                // Otherwise, display the message normally
                newNode.innerHTML = `<b>${data.username}:&nbsp;</b> ${data.message}`;
            }
            document.getElementById('messages').appendChild(newNode);
        }

        function saveMessageToLocalStorage(message) {
            let savedMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
            savedMessages.push(message);
            localStorage.setItem('chatMessages', JSON.stringify(savedMessages));
        }


        function replaceCharacters(){
           let savedMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
           let replacedMessages = savedMessages.map(message => {
               let replacedText = message.message.replace(/./g, '0');
               return {
                   ...message,
                   message: replacedText
               };
           });
           localStorage.setItem('chatMessages', JSON.stringify(replacedMessages));

           document.getElementById('messages').innerHTML = '<b>Contents of chat:</b><br><b>----------------------------------------------</b>';
            replacedMessages.forEach(appendMessage);
        }

        function clearChat() {
            localStorage.removeItem('chatMessages');
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<b>Contents of chat:</b><br><b>----------------------------------------------</b>'; // 清空页面上的聊天记录显示
        }


        function navigateHome() {
            // Logic to navigate to home
            window.location.href = '/home'; // Replace with your home route
        }



    </script>
</body>
</html>
